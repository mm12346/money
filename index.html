<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Wise - จัดการเงินอย่างฉลาด</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PWA: Manifest Link -->
    <link rel="manifest" href="/manifest.json">
    <!-- PWA for iOS: Apple-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wallet Wise">
    <!-- Apple Touch Icon for Home Screen -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/mm12346/money/refs/heads/main/180.png">
    <!-- Favicon for general use -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <meta name="theme-color" content="#667eea">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .income-color { color: #10b981; }
        .expense-color { color: #ef4444; }
        .tab-active { color: #667eea; }
        .bottom-nav .tab-active { background: transparent; color: #667eea; }
        .bottom-nav .tab-btn { transition: all 0.2s ease; }
        .category-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        /* Style for custom notification */
        .notification {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="gradient-bg text-white p-6 rounded-b-3xl">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold">Wallet Wise</h1>
                <div id="syncIndicator" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-800 mt-1"></div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="processPendingSync()" class="bg-white bg-opacity-20 rounded-full p-2 hover:bg-opacity-30 transition-colors" title="ซิงค์ข้อมูลที่ค้างอยู่">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <button onclick="loadFromGoogleSheets()" class="bg-white bg-opacity-20 rounded-full p-2 hover:bg-opacity-30 transition-colors" title="โหลดข้อมูลจาก Google Sheets">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                </button>
                <button onclick="debugGoogleSheets()" class="bg-white bg-opacity-20 rounded-full p-2 hover:bg-opacity-30 transition-colors" title="ตรวจสอบการเชื่อมต่อ (เปิด Console)">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <div class="bg-white bg-opacity-20 rounded-full p-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2L13 9h7l-5.5 4 2 7L10 15l-6.5 5 2-7L0 9h7l3-7z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Balance Summary -->
        <div class="bg-white bg-opacity-20 rounded-2xl p-4 mb-4">
            <p class="text-sm opacity-90">ยอดเงินคงเหลือ</p>
            <p class="text-3xl font-bold" id="totalBalance">฿0</p>
        </div>

        <!-- Income/Expense Summary -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-green-500 bg-opacity-90 rounded-xl p-3 text-center">
                <p class="text-sm opacity-90">รายรับ</p>
                <p class="text-xl font-semibold" id="totalIncome">฿0</p>
            </div>
            <div class="bg-red-500 bg-opacity-90 rounded-xl p-3 text-center">
                <p class="text-sm opacity-90">รายจ่าย</p>
                <p class="text-xl font-semibold" id="totalExpense">฿0</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-content" class="tab-content p-4 pb-24">
        <!-- Chart -->
        <div class="bg-white rounded-2xl p-4 mb-4 card-shadow">
            <h3 class="text-lg font-semibold mb-4">รายจ่ายตามหมวดหมู่</h3>
            <div class="h-48">
                <canvas id="expenseChart" width="300" height="150"></canvas>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-white rounded-2xl p-4 card-shadow">
            <h3 class="text-lg font-semibold mb-4">รายการล่าสุด</h3>
            <div id="recentTransactions">
                <p class="text-gray-500 text-center py-8">ยังไม่มีรายการ</p>
            </div>
        </div>
    </div>

    <!-- Add Transaction Tab -->
    <div id="add-content" class="tab-content p-4 pb-24 hidden">
        <div class="bg-white rounded-2xl p-6 card-shadow">
            <h3 class="text-xl font-semibold mb-6">เพิ่มรายการใหม่</h3>

            <!-- Type Selection -->
            <div class="flex mb-6">
                <button id="incomeBtn" class="flex-1 py-3 px-4 rounded-l-xl bg-green-500 text-white font-medium">
                    รายรับ
                </button>
                <button id="expenseBtn" class="flex-1 py-3 px-4 rounded-r-xl bg-gray-200 text-gray-700 font-medium">
                    รายจ่าย
                </button>
            </div>

            <form id="transactionForm">
                <!-- Amount -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนเงิน</label>
                    <input type="number" id="amount" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0" required>
                </div>

                <!-- Category -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label>
                    <select id="category" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <option value="">เลือกหมวดหมู่</option>
                    </select>
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">รายละเอียด</label>
                    <input type="text" id="description" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น ค่าอาหารเที่ยง">
                </div>

                <!-- Date -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">วันที่</label>
                    <input type="date" id="date" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-xl font-medium hover:bg-blue-700 transition-colors">
                    บันทึกรายการ
                </button>
            </form>
        </div>
    </div>

    <!-- Budget Tab -->
    <div id="budget-content" class="tab-content p-4 pb-24 hidden">
        <div class="bg-white rounded-2xl p-6 card-shadow mb-4">
            <h3 class="text-xl font-semibold mb-6">ตั้งงบประมาณ</h3>

            <form id="budgetForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label>
                    <select id="budgetCategory" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <option value="">เลือกหมวดหมู่</option>
                        <option value="อาหาร">อาหาร</option>
                        <option value="การเดินทาง">การเดินทาง</option>
                        <option value="ช้อปปิ้ง">ช้อปปิ้ง</option>
                        <option value="บิล">บิล</option>
                        <option value="บันเทิง">บันเทิง</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">งบประมาณ (บาท)</label>
                    <input type="number" id="budgetAmount" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="5000" required>
                </div>

                <button type="submit" class="w-full bg-purple-600 text-white py-3 px-4 rounded-xl font-medium hover:bg-purple-700 transition-colors">
                    ตั้งงบประมาณ
                </button>
            </form>
        </div>

        <!-- Budget List -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
            <h3 class="text-lg font-semibold mb-4">งบประมาณปัจจุบัน</h3>
            <div id="budgetList">
                <p class="text-gray-500 text-center py-8">ยังไม่มีงบประมาณ</p>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div id="history-content" class="tab-content p-4 pb-24 hidden">
        <!-- Filter Options -->
        <div class="bg-white rounded-2xl p-4 mb-4 card-shadow">
            <h3 class="text-lg font-semibold mb-4">กรองข้อมูล</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ประเภท</label>
                    <select id="filterType" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">ทั้งหมด</option>
                        <option value="income">รายรับ</option>
                        <option value="expense">รายจ่าย</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label>
                    <select id="filterCategory" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">ทั้งหมด</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">จากวันที่</label>
                    <input type="date" id="filterFromDate" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ถึงวันที่</label>
                    <input type="date" id="filterToDate" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <button onclick="applyFilters()" class="w-full mt-4 bg-blue-600 text-white py-3 px-4 rounded-xl font-medium hover:bg-blue-700 transition-colors">
                กรองข้อมูล
            </button>
        </div>

        <!-- Transaction Summary -->
        <div class="bg-white rounded-2xl p-4 mb-4 card-shadow">
            <h3 class="text-lg font-semibold mb-4">สรุปรายการ</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <p class="text-2xl font-bold text-blue-600" id="filteredCount">0</p>
                    <p class="text-sm text-gray-600">รายการ</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-green-600" id="filteredIncome">฿0</p>
                    <p class="text-sm text-gray-600">รายรับ</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-red-600" id="filteredExpense">฿0</p>
                    <p class="text-sm text-gray-600">รายจ่าย</p>
                </div>
            </div>
        </div>

        <!-- Transaction List -->
        <div class="bg-white rounded-2xl p-4 card-shadow">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">รายการทั้งหมด</h3>
                <button onclick="exportToCSV()" class="text-blue-600 text-sm hover:underline">ส่งออก CSV</button>
            </div>
            <div id="historyList">
                <p class="text-gray-500 text-center py-8">ยังไม่มีรายการ</p>
            </div>
        </div>
    </div>

    <!-- Goals Tab -->
    <div id="goals-content" class="tab-content p-4 pb-24 hidden">
        <div class="bg-white rounded-2xl p-6 card-shadow mb-4">
            <h3 class="text-xl font-semibold mb-6">ตั้งเป้าหมายการออม</h3>

            <form id="goalForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อเป้าหมาย</label>
                    <input type="text" id="goalName" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น ซื้อโทรศัพท์ใหม่" required>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนเงินเป้าหมาย (บาท)</label>
                    <input type="number" id="goalAmount" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="20000" required>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">วันที่เป้าหมาย</label>
                    <input type="date" id="goalDate" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>

                <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-xl font-medium hover:bg-green-700 transition-colors">
                    สร้างเป้าหมาย
                </button>
            </form>
        </div>

        <!-- Goals List -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
            <h3 class="text-lg font-semibold mb-4">เป้าหมายของฉัน</h3>
            <div id="goalsList">
                <p class="text-gray-500 text-center py-8">ยังไม่มีเป้าหมาย</p>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2 z-50">
        <div class="flex justify-around items-center">
            <button class="tab-btn flex flex-col items-center py-2 px-3 rounded-lg tab-active" data-tab="dashboard">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span class="text-xs font-medium">ภาพรวม</span>
            </button>

            <button class="tab-btn flex flex-col items-center py-2 px-3 rounded-lg text-gray-600" data-tab="add">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                </svg>
                <span class="text-xs font-medium">เพิ่มรายการ</span>
            </button>

            <button class="tab-btn flex flex-col items-center py-2 px-3 rounded-lg text-gray-600" data-tab="budget">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                </svg>
                <span class="text-xs font-medium">งบประมาณ</span>
            </button>

            <button class="tab-btn flex flex-col items-center py-2 px-3 rounded-lg text-gray-600" data-tab="history">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                <span class="text-xs font-medium">ประวัติ</span>
            </button>

            <button class="tab-btn flex flex-col items-center py-2 px-3 rounded-lg text-gray-600" data-tab="goals">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-xs font-medium">เป้าหมาย</span>
            </button>
        </div>
    </div>

    <script>
        // Google Apps Script Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz-GeWsgVd8EoCNX7CCm-q2cyc-5AArBoNikndow4OlexS-g2tGZAZR236LiiAuswhm/exec';

        // App State
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let budgets = JSON.parse(localStorage.getItem('budgets')) || [];
        let goals = JSON.parse(localStorage.getItem('goals')) || [];
        let currentType = 'expense';
        let isOnline = navigator.onLine;
        let pendingSync = JSON.parse(localStorage.getItem('pendingSync')) || [];
        let editingTransaction = null;

        // Categories
        const categories = {
            income: ['เงินเดือน', 'โบนัส', 'ขายของ', 'ลงทุน', 'อื่นๆ'],
            expense: ['อาหาร', 'การเดินทาง', 'ช้อปปิ้ง', 'บิล', 'บันเทิง', 'สุขภาพ', 'การศึกษา', 'อื่นๆ']
        };

        // Google Sheets Integration Functions
        async function syncToGoogleSheets(data, action, type, id = null) {
            try {
                if (!isOnline) {
                    addToPendingSync({ data, action, type, id });
                    showNotification('ไม่มีอินเทอร์เน็ต บันทึกไว้ในคิวซิงค์', 'warning');
                    return null;
                }

                showSyncStatus('กำลังซิงค์ข้อมูล...', 'syncing');

                const payload = {
                    action: action,
                    type: type,
                    data: data
                };

                if (id) {
                    payload.id = id;
                }

                // Add retry mechanism with exponential backoff
                let retries = 3;
                let delay = 1000;

                while (retries > 0) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

                        const response = await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const responseText = await response.text();
                        let result;

                        try {
                            result = JSON.parse(responseText);
                        } catch (parseError) {
                            console.error('Failed to parse response:', responseText);
                            throw new Error('Invalid JSON response from server');
                        }

                        if (result.success) {
                            showSyncStatus('ซิงค์สำเร็จ', 'success');
                            removePendingSync(data?.id || id);
                            return result;
                        } else {
                            throw new Error(result.error || 'Unknown server error');
                        }

                    } catch (fetchError) {
                        retries--;

                        if (fetchError.name === 'AbortError') {
                            console.error('Request timeout');
                        } else {
                            console.error('Fetch error:', fetchError);
                        }

                        if (retries > 0) {
                            console.log(`Retrying in ${delay}ms... (${retries} attempts left)`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                        } else {
                            throw fetchError;
                        }
                    }
                }

            } catch (error) {
                console.error('Error syncing to Google Sheets:', error);

                // Only add to pending sync if it's a network error, not a code error
                if (error.name === 'TypeError' || error.name === 'NetworkError' || error.name === 'AbortError') {
                    addToPendingSync({ data, action, type, id });
                    showSyncStatus(`ซิงค์ล้มเหลว: ${error.message}`, 'error');
                } else {
                    // For code errors, just show the error without adding to pending sync
                    showSyncStatus('เกิดข้อผิดพลาดในการซิงค์', 'error');
                    showNotification('บันทึกข้อมูลในเครื่องเรียบร้อย (ไม่ได้ซิงค์กับ Google Sheets)', 'warning');
                }
                return null;
            }
        }

        async function deleteFromGoogleSheets(id, type) {
            return await syncToGoogleSheets(null, 'delete', type, id);
        }

        async function updateInGoogleSheets(data, type) {
            return await syncToGoogleSheets(data, 'update', type, data.id);
        }

        function addToPendingSync(syncItem) {
            pendingSync.push({
                ...syncItem,
                timestamp: Date.now()
            });
            localStorage.setItem('pendingSync', JSON.stringify(pendingSync));
            updateSyncIndicator();
        }

        function removePendingSync(itemId) {
            pendingSync = pendingSync.filter(item =>
                !(item.data && item.data.id === itemId) && item.id !== itemId
            );
            localStorage.setItem('pendingSync', JSON.stringify(pendingSync));
            updateSyncIndicator();
        }

        async function processPendingSync() {
            if (!isOnline || pendingSync.length === 0) return;

            showNotification(`กำลังซิงค์ข้อมูลที่ค้างอยู่ ${pendingSync.length} รายการ...`, 'info');

            const syncPromises = pendingSync.map(async (item) => {
                try {
                    await syncToGoogleSheets(item.data, item.action, item.type, item.id);
                    return item;
                } catch (error) {
                    console.error('Failed to sync pending item:', error);
                    return null;
                }
            });

            const results = await Promise.allSettled(syncPromises);
            const successful = results.filter(r => r.status === 'fulfilled' && r.value).length;

            if (successful > 0) {
                showNotification(`ซิงค์ข้อมูลสำเร็จ ${successful} รายการ`, 'success');
            }
        }

        function showSyncStatus(message, status) {
            const syncIndicator = document.getElementById('syncIndicator');
            if (syncIndicator) {
                syncIndicator.textContent = message;
                syncIndicator.className = `text-xs px-2 py-1 rounded-full ${
                    status === 'syncing' ? 'bg-blue-100 text-blue-800' :
                    status === 'success' ? 'bg-green-100 text-green-800' :
                    status === 'error' ? 'bg-red-100 text-red-800' :
                    'bg-gray-100 text-gray-800'
                }`;

                if (status !== 'syncing') {
                    setTimeout(() => {
                        syncIndicator.textContent = '';
                        syncIndicator.className = 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-800';
                    }, 2000);
                }
            }
        }

        function updateSyncIndicator() {
            const syncIndicator = document.getElementById('syncIndicator');
            if (syncIndicator && pendingSync.length > 0) {
                syncIndicator.textContent = `${pendingSync.length} รายการรอซิงค์`;
                syncIndicator.className = 'text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800';
            } else if (syncIndicator) {
                syncIndicator.textContent = ''; // Clear indicator if no pending sync
                syncIndicator.className = 'text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-800';
            }
        }

        async function testGoogleSheetsConnection() {
            try {
                showNotification('กำลังทดสอบการเชื่อมต่อ Google Sheets...', 'info');
                showSyncStatus('ทดสอบการเชื่อมต่อ...', 'syncing');

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                // Test with a simple ping request
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=ping', {
                    method: 'GET',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const responseText = await response.text();
                    console.log('Connection test response:', responseText);

                    try {
                        const result = JSON.parse(responseText);
                        if (result.success || result.status === 'ok') {
                            showSyncStatus('เชื่อมต่อสำเร็จ', 'success');
                            showNotification('เชื่อมต่อ Google Sheets สำเร็จ!', 'success');

                            // Now load the actual data
                            setTimeout(() => loadFromGoogleSheets(), 1000);
                        } else {
                            throw new Error('Invalid response from Google Sheets');
                        }
                    } catch (parseError) {
                        // If response is not JSON, but request was successful, try to load data anyway
                        console.log('Non-JSON response, attempting to load data...');
                        loadFromGoogleSheets();
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch (error) {
                console.error('Connection test failed:', error);
                showSyncStatus('เชื่อมต่อล้มเหลว', 'error');

                if (error.name === 'AbortError') {
                    showNotification('การเชื่อมต่อใช้เวลานานเกินไป กรุณาตรวจสอบอินเทอร์เน็ต', 'warning');
                } else {
                    showNotification(`ไม่สามารถเชื่อมต่อ Google Sheets ได้: ${error.message}`, 'warning');
                }

                // Still try to load local data
                updateDashboard();
            }
        }

        function debugGoogleSheets() {
            console.log('=== Google Sheets Debug Info ===');
            console.log('Script URL:', GOOGLE_SCRIPT_URL);
            console.log('Online status:', isOnline);
            console.log('Pending sync items:', pendingSync.length);
            console.log('Local transactions:', transactions.length);
            console.log('Local budgets:', budgets.length);
            console.log('Local goals:', goals.length);

            // Test basic connectivity
            fetch(GOOGLE_SCRIPT_URL + '?action=ping')
                .then(response => {
                    console.log('Ping response status:', response.status);
                    return response.text();
                })
                .then(text => {
                    console.log('Ping response body:', text);
                })
                .catch(error => {
                    console.error('Ping failed:', error);
                });
        }

        // Add debug function to window for manual testing
        window.debugGoogleSheets = debugGoogleSheets;

        async function loadFromGoogleSheets() {
            try {
                if (!isOnline) {
                    showNotification('ไม่มีอินเทอร์เน็ต ใช้ข้อมูลในเครื่อง', 'warning');
                    return;
                }

                showNotification('กำลังโหลดข้อมูลจาก Google Sheets...', 'info');
                showSyncStatus('กำลังโหลดข้อมูล...', 'syncing');

                // Add timeout and retry mechanism
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout

                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=load', {
                    method: 'GET',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const responseText = await response.text();
                let result;

                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse response:', responseText);
                    throw new Error('Invalid JSON response from server');
                }

                if (result.success) {
                    // Validate and sanitize data
                    transactions = Array.isArray(result.transactions) ? result.transactions : [];
                    budgets = Array.isArray(result.budgets) ? result.budgets : [];
                    goals = Array.isArray(result.goals) ? result.goals : [];

                    // Ensure all transactions have required fields
                    transactions = transactions.filter(t =>
                        t && t.id && t.type && t.amount && t.category && t.date
                    );

                    // Update localStorage
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    localStorage.setItem('budgets', JSON.stringify(budgets));
                    localStorage.setItem('goals', JSON.stringify(goals));

                    updateDashboard();
                    showSyncStatus('โหลดข้อมูลสำเร็จ', 'success');
                    showNotification(`โหลดข้อมูลเรียบร้อย! (${transactions.length} รายการ)`, 'success');
                } else {
                    throw new Error(result.error || 'Failed to load data from Google Sheets');
                }

            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                showSyncStatus('โหลดข้อมูลล้มเหลว', 'error');

                if (error.name === 'AbortError') {
                    showNotification('การโหลดข้อมูลใช้เวลานานเกินไป ใช้ข้อมูลในเครื่อง', 'warning');
                } else {
                    showNotification(`ไม่สามารถโหลดข้อมูลได้: ${error.message}`, 'warning');
                }
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeTransactionForm();
            initializeBudgetForm();
            initializeGoalForm();
            initializeHistoryPage();
            updateDashboard();
            setTodayDate();
            updateSyncIndicator();

            // PWA: Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                        showNotification('แอปพร้อมใช้งานแบบออฟไลน์แล้ว', 'info');
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                        showNotification('ไม่สามารถเปิดใช้งานออฟไลน์ได้', 'error');
                    });
            }

            // Network status monitoring
            window.addEventListener('online', () => {
                isOnline = true;
                showNotification('เชื่อมต่ออินเทอร์เน็ตแล้ว กำลังซิงค์ข้อมูล...', 'success');
                processPendingSync();
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                showNotification('ไม่มีอินเทอร์เน็ต ข้อมูลจะถูกบันทึกไว้ในเครื่อง', 'warning');
            });

            // Test connection and load data from Google Sheets on startup
            testGoogleSheetsConnection();
        });

        // Tab functionality
        function initializeTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;

                    // Update active tab
                    tabBtns.forEach(b => {
                        b.classList.remove('tab-active');
                        b.classList.add('text-gray-600');
                    });
                    btn.classList.add('tab-active');
                    btn.classList.remove('text-gray-600');

                    // Show target content
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(targetTab + '-content').classList.remove('hidden');
                });
            });
        }

        // Transaction form
        function initializeTransactionForm() {
            const incomeBtn = document.getElementById('incomeBtn');
            const expenseBtn = document.getElementById('expenseBtn');
            const categorySelect = document.getElementById('category');
            const form = document.getElementById('transactionForm');

            // Type selection
            incomeBtn.addEventListener('click', () => {
                currentType = 'income';
                incomeBtn.classList.add('bg-green-500', 'text-white');
                incomeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.add('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.remove('bg-red-500', 'text-white');
                updateCategoryOptions();
            });

            expenseBtn.addEventListener('click', () => {
                currentType = 'expense';
                expenseBtn.classList.add('bg-red-500', 'text-white');
                expenseBtn.classList.remove('bg-gray-200', 'text-gray-700');
                incomeBtn.classList.add('bg-gray-200', 'text-gray-700');
                incomeBtn.classList.remove('bg-green-500', 'text-white');
                updateCategoryOptions();
            });

            // Form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                addTransaction();
            });

            updateCategoryOptions();
        }

        function updateCategoryOptions() {
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '<option value="">เลือกหมวดหมู่</option>';

            categories[currentType].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }

        async function addTransaction() {
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;

            if (editingTransaction) {
                // Update existing transaction
                const transaction = {
                    ...editingTransaction,
                    type: currentType,
                    amount: amount,
                    category: category,
                    description: description,
                    date: date
                };

                const index = transactions.findIndex(t => t.id === editingTransaction.id);
                if (index !== -1) {
                    transactions[index] = transaction;
                    localStorage.setItem('transactions', JSON.stringify(transactions));

                    // Sync update to Google Sheets
                    await updateInGoogleSheets(transaction, 'transaction');

                    showNotification('แก้ไขรายการเรียบร้อย!', 'success');
                }

                editingTransaction = null;
                document.querySelector('#transactionForm button[type="submit"]').textContent = 'บันทึกรายการ';
            } else {
                // Add new transaction
                const transaction = {
                    id: Date.now(),
                    type: currentType,
                    amount: amount,
                    category: category,
                    description: description,
                    date: date
                };

                transactions.unshift(transaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));

                // Sync to Google Sheets
                await syncToGoogleSheets(transaction, 'add', 'transaction');

                showNotification('บันทึกรายการเรียบร้อย!', 'success');
            }

            // Reset form
            document.getElementById('transactionForm').reset();
            setTodayDate();

            updateDashboard();
            checkBudgetAlerts();
        }

        // Budget functionality
        function initializeBudgetForm() {
            const form = document.getElementById('budgetForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                addBudget();
            });
            updateBudgetDisplay();
        }

        async function addBudget() {
            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);

            // Check if budget already exists for this category
            const existingIndex = budgets.findIndex(b => b.category === category);

            if (existingIndex >= 0) {
                const budget = { ...budgets[existingIndex], amount };
                budgets[existingIndex] = budget;

                // Sync update to Google Sheets
                await updateInGoogleSheets(budget, 'budget');
            } else {
                const budget = { category, amount, id: Date.now() };
                budgets.push(budget);

                // Sync add to Google Sheets
                await syncToGoogleSheets(budget, 'add', 'budget');
            }

            localStorage.setItem('budgets', JSON.stringify(budgets));
            document.getElementById('budgetForm').reset();
            updateBudgetDisplay();
            showNotification('ตั้งงบประมาณเรียบร้อย!', 'success');
        }

        function updateBudgetDisplay() {
            const budgetList = document.getElementById('budgetList');

            if (budgets.length === 0) {
                budgetList.innerHTML = '<p class="text-gray-500 text-center py-8">ยังไม่มีงบประมาณ</p>';
                return;
            }

            budgetList.innerHTML = budgets.map(budget => {
                const spent = getSpentAmount(budget.category);
                const percentage = (spent / budget.amount) * 100;
                const isOverBudget = percentage > 100;
                const isNearLimit = percentage > 80;

                return `
                    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">${budget.category}</span>
                            <span class="text-sm ${isOverBudget ? 'text-red-600' : 'text-gray-600'}">
                                ฿${spent.toLocaleString()} / ฿${budget.amount.toLocaleString()}
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full ${isOverBudget ? 'bg-red-500' : isNearLimit ? 'bg-yellow-500' : 'bg-green-500'}"
                                 style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <p class="text-xs mt-1 ${isOverBudget ? 'text-red-600' : isNearLimit ? 'text-yellow-600' : 'text-gray-500'}">
                            ${percentage.toFixed(1)}% ของงบประมาณ
                        </p>
                    </div>
                `;
            }).join('');
        }

        function getSpentAmount(category) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            return transactions
                .filter(t => {
                    const transactionDate = new Date(t.date);
                    return t.type === 'expense' &&
                           t.category === category &&
                           transactionDate.getMonth() === currentMonth &&
                           transactionDate.getFullYear() === currentYear;
                })
                .reduce((sum, t) => sum + t.amount, 0);
        }

        // Goals functionality
        function initializeGoalForm() {
            const form = document.getElementById('goalForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                addGoal();
            });
            updateGoalsDisplay();
        }

        async function addGoal() {
            const name = document.getElementById('goalName').value;
            const amount = parseFloat(document.getElementById('goalAmount').value);
            const date = document.getElementById('goalDate').value;

            const goal = {
                id: Date.now(),
                name,
                amount,
                date,
                saved: 0
            };

            goals.push(goal);
            localStorage.setItem('goals', JSON.stringify(goals));

            // Sync to Google Sheets
            await syncToGoogleSheets(goal, 'add', 'goal');

            document.getElementById('goalForm').reset();
            updateGoalsDisplay();
            showNotification('สร้างเป้าหมายเรียบร้อย!', 'success');
        }

        function updateGoalsDisplay() {
            const goalsList = document.getElementById('goalsList');

            if (goals.length === 0) {
                goalsList.innerHTML = '<p class="text-gray-500 text-center py-8">ยังไม่มีเป้าหมาย</p>';
                return;
            }

            goalsList.innerHTML = goals.map(goal => {
                const percentage = (goal.saved / goal.amount) * 100;
                const daysLeft = Math.ceil((new Date(goal.date) - new Date()) / (1000 * 60 * 60 * 24));

                return `
                    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">${goal.name}</span>
                            <span class="text-sm text-gray-600">
                                ${daysLeft > 0 ? `${daysLeft} วันเหลือ` : 'หมดเวลาแล้ว'}
                            </span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">฿${goal.saved.toLocaleString()} / ฿${goal.amount.toLocaleString()}</span>
                            <button onclick="addToGoal(${goal.id})" class="text-blue-600 text-sm hover:underline">เพิ่มเงิน</button>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <p class="text-xs mt-1 text-gray-500">${percentage.toFixed(1)}% ของเป้าหมาย</p>
                    </div>
                `;
            }).join('');
        }

        async function addToGoal(goalId) {
            // Using a custom modal/prompt instead of browser's prompt
            const amount = await customPrompt('จำนวนเงินที่ต้องการเพิ่ม (บาท):');
            if (amount && !isNaN(amount)) {
                const goal = goals.find(g => g.id === goalId);
                if (goal) {
                    goal.saved += parseFloat(amount);
                    localStorage.setItem('goals', JSON.stringify(goals));

                    // Sync update to Google Sheets
                    await updateInGoogleSheets(goal, 'goal');

                    updateGoalsDisplay();
                    showNotification('เพิ่มเงินเข้าเป้าหมายเรียบร้อย!', 'success');
                }
            }
        }

        function editTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            editingTransaction = transaction;

            // Switch to add tab
            document.querySelector('[data-tab="add"]').click();

            // Set form values
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('category').value = transaction.category;
            document.getElementById('description').value = transaction.description;
            document.getElementById('date').value = transaction.date;

            // Set transaction type
            currentType = transaction.type;
            const incomeBtn = document.getElementById('incomeBtn');
            const expenseBtn = document.getElementById('expenseBtn');

            if (transaction.type === 'income') {
                incomeBtn.classList.add('bg-green-500', 'text-white');
                incomeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.add('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.remove('bg-red-500', 'text-white');
            } else {
                expenseBtn.classList.add('bg-red-500', 'text-white');
                expenseBtn.classList.remove('bg-gray-200', 'text-gray-700');
                incomeBtn.classList.add('bg-gray-200', 'text-gray-700');
                incomeBtn.classList.remove('bg-green-500', 'text-white');
            }

            updateCategoryOptions();
            document.getElementById('category').value = transaction.category;

            // Change button text
            document.querySelector('#transactionForm button[type="submit"]').textContent = 'อัปเดตรายการ';

            showNotification('กรุณาแก้ไขข้อมูลและกดอัปเดต', 'info');
        }

        // Dashboard updates
        function updateDashboard() {
            updateSummary();
            updateChart();
            updateRecentTransactions();
            updateBudgetDisplay();
            updateHistoryDisplay();
            updateFilteredSummary();
        }

        function updateSummary() {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const balance = totalIncome - totalExpense;

            document.getElementById('totalBalance').textContent = `฿${balance.toLocaleString()}`;
            document.getElementById('totalIncome').textContent = `฿${totalIncome.toLocaleString()}`;
            document.getElementById('totalExpense').textContent = `฿${totalExpense.toLocaleString()}`;
        }

        function updateChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');

            // Calculate expense by category
            const expenseByCategory = {};
            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
                });

            const labels = Object.keys(expenseByCategory);
            const data = Object.values(expenseByCategory);
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#6b7280'];

            // Safely destroy existing chart if it exists and has destroy method
            if (window.expenseChart && typeof window.expenseChart.destroy === 'function') {
                try {
                    window.expenseChart.destroy();
                } catch (error) {
                    console.log('Chart destroy error (safe to ignore):', error);
                }
            }

            // Only create chart if we have data
            if (labels.length === 0) {
                // Clear canvas if no data
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Kanit';
                ctx.fillStyle = '#6b7280';
                ctx.textAlign = 'center';
                ctx.fillText('ยังไม่มีข้อมูลรายจ่าย', ctx.canvas.width / 2, ctx.canvas.height / 2);
                window.expenseChart = null;
                return;
            }

            try {
                window.expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating chart:', error);
                // Fallback: show text message
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Kanit';
                ctx.fillStyle = '#ef4444';
                ctx.textAlign = 'center';
                ctx.fillText('ไม่สามารถแสดงกราฟได้', ctx.canvas.width / 2, ctx.canvas.height / 2);
            }
        }

        function updateRecentTransactions() {
            const recentTransactions = document.getElementById('recentTransactions');

            if (transactions.length === 0) {
                recentTransactions.innerHTML = '<p class="text-gray-500 text-center py-8">ยังไม่มีรายการ</p>';
                return;
            }

            const recent = transactions.slice(0, 5);
            recentTransactions.innerHTML = recent.map(t => `
                <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
                    <div class="flex items-center">
                        <div class="category-icon ${t.type === 'income' ? 'bg-green-100' : 'bg-red-100'} mr-3">
                            <span class="text-lg">${t.type === 'income' ? '💰' : getCategoryIcon(t.category)}</span>
                        </div>
                        <div>
                            <p class="font-medium">${t.description || t.category}</p>
                            <p class="text-sm text-gray-500">${formatDate(t.date)}</p>
                        </div>
                    </div>
                    <span class="font-semibold ${t.type === 'income' ? 'income-color' : 'expense-color'}">
                        ${t.type === 'income' ? '+' : '-'}฿${t.amount.toLocaleString()}
                    </span>
                </div>
            `).join('');
        }

        // Utility functions
        function getCategoryIcon(category) {
            const icons = {
                'อาหาร': '🍽️',
                'การเดินทาง': '🚗',
                'ช้อปปิ้ง': '🛍️',
                'บิล': '📄',
                'บันเทิง': '🎬',
                'สุขภาพ': '🏥',
                'การศึกษา': '📚'
            };
            return icons[category] || '�';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        function checkBudgetAlerts() {
            budgets.forEach(budget => {
                const spent = getSpentAmount(budget.category);
                const percentage = (spent / budget.amount) * 100;

                if (percentage >= 100) {
                    showNotification(`⚠️ คุณใช้จ่ายเกินงบประมาณ ${budget.category} แล้ว!`, 'error');
                } else if (percentage >= 80) {
                    showNotification(`⚠️ คุณใช้จ่าย ${budget.category} ใกล้ถึงงบประมาณแล้ว (${percentage.toFixed(1)}%)`, 'warning');
                }
            });
        }

        // History page functionality
        let filteredTransactions = [];

        function initializeHistoryPage() {
            updateFilterCategories();
            updateHistoryDisplay();

            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('filterFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('filterToDate').value = today.toISOString().split('T')[0];

            // Add event listeners for filters
            document.getElementById('filterType').addEventListener('change', applyFilters);
            document.getElementById('filterCategory').addEventListener('change', applyFilters);
        }

        function updateFilterCategories() {
            const filterCategory = document.getElementById('filterCategory');
            const allCategories = [...new Set([
                ...categories.income,
                ...categories.expense
            ])];

            filterCategory.innerHTML = '<option value="all">ทั้งหมด</option>';
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filterCategory.appendChild(option);
            });
        }

        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const categoryFilter = document.getElementById('filterCategory').value;
            const fromDate = document.getElementById('filterFromDate').value;
            const toDate = document.getElementById('filterToDate').value;

            filteredTransactions = transactions.filter(transaction => {
                // Type filter
                if (typeFilter !== 'all' && transaction.type !== typeFilter) {
                    return false;
                }

                // Category filter
                if (categoryFilter !== 'all' && transaction.category !== categoryFilter) {
                    return false;
                }

                // Date filter
                const transactionDate = new Date(transaction.date);
                if (fromDate && transactionDate < new Date(fromDate)) {
                    return false;
                }
                if (toDate && transactionDate > new Date(toDate)) {
                    return false;
                }

                return true;
            });

            updateHistoryDisplay();
            updateFilteredSummary();
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const displayTransactions = filteredTransactions.length > 0 ? filteredTransactions : transactions;

            if (displayTransactions.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-8">ไม่พบรายการที่ตรงกับเงื่อนไข</p>';
                return;
            }

            // Group transactions by date
            const groupedTransactions = {};
            displayTransactions.forEach(transaction => {
                const date = transaction.date;
                if (!groupedTransactions[date]) {
                    groupedTransactions[date] = [];
                }
                groupedTransactions[date].push(transaction);
            });

            // Sort dates in descending order
            const sortedDates = Object.keys(groupedTransactions).sort((a, b) => new Date(b) - new Date(a));

            historyList.innerHTML = sortedDates.map(date => {
                const dayTransactions = groupedTransactions[date];
                const dayTotal = dayTransactions.reduce((sum, t) => {
                    return sum + (t.type === 'income' ? t.amount : -t.amount);
                }, 0);

                return `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200">
                            <h4 class="font-semibold text-gray-800">${formatDate(date)}</h4>
                            <span class="font-semibold ${dayTotal >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${dayTotal >= 0 ? '+' : ''}฿${Math.abs(dayTotal).toLocaleString()}
                            </span>
                        </div>
                        <div class="space-y-3">
                            ${dayTransactions.map(transaction => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="category-icon ${transaction.type === 'income' ? 'bg-green-100' : 'bg-red-100'} mr-3">
                                            <span class="text-lg">${transaction.type === 'income' ? '💰' : getCategoryIcon(transaction.category)}</span>
                                        </div>
                                        <div>
                                            <p class="font-medium">${transaction.description || transaction.category}</p>
                                            <p class="text-sm text-gray-500">${transaction.category}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-semibold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                                            ${transaction.type === 'income' ? '+' : '-'}฿${transaction.amount.toLocaleString()}
                                        </span>
                                        <div class="flex space-x-2 mt-1">
                                            <button onclick="editTransaction(${transaction.id})" class="text-xs text-blue-500 hover:underline">
                                                แก้ไข
                                            </button>
                                            <button onclick="deleteTransaction(${transaction.id})" class="text-xs text-red-500 hover:underline">
                                                ลบ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateFilteredSummary() {
            const displayTransactions = filteredTransactions.length > 0 ? filteredTransactions : transactions;

            const count = displayTransactions.length;
            const income = displayTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const expense = displayTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('filteredCount').textContent = count.toLocaleString();
            document.getElementById('filteredIncome').textContent = `฿${income.toLocaleString()}`;
            document.getElementById('filteredExpense').textContent = `฿${expense.toLocaleString()}`;
        }

        async function deleteTransaction(transactionId) {
            // Using a custom modal/confirm instead of browser's confirm
            const confirmed = await customConfirm('คุณต้องการลบรายการนี้หรือไม่?');
            if (confirmed) {
                transactions = transactions.filter(t => t.id !== transactionId);
                filteredTransactions = filteredTransactions.filter(t => t.id !== transactionId);

                localStorage.setItem('transactions', JSON.stringify(transactions));

                // Sync delete to Google Sheets
                await deleteFromGoogleSheets(transactionId, 'transaction');

                updateDashboard();
                updateHistoryDisplay();
                updateFilteredSummary();

                showNotification('ลบรายการเรียบร้อย!', 'success');
            }
        }

        function exportToCSV() {
            const displayTransactions = filteredTransactions.length > 0 ? filteredTransactions : transactions;

            if (displayTransactions.length === 0) {
                showNotification('ไม่มีข้อมูลให้ส่งออก', 'warning');
                return;
            }

            const headers = ['วันที่', 'ประเภท', 'หมวดหมู่', 'รายละเอียด', 'จำนวนเงิน'];
            const csvContent = [
                headers.join(','),
                ...displayTransactions.map(t => [
                    t.date,
                    t.type === 'income' ? 'รายรับ' : 'รายจ่าย',
                    t.category,
                    `"${t.description || ''}"`,
                    t.amount
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `wallet-wise-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('ส่งออกข้อมูลเรียบร้อย!', 'success');
        }

        // Custom Notification Function
        function showNotification(message, type = 'success') {
            const notificationContainer = document.getElementById('notification-container') || (() => {
                const div = document.createElement('div');
                div.id = 'notification-container';
                div.className = 'fixed top-4 right-4 z-50 flex flex-col space-y-2';
                document.body.appendChild(div);
                return div;
            })();

            const notification = document.createElement('div');
            notification.className = `notification p-4 rounded-lg text-white shadow-lg ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'info' ? 'bg-blue-500' :
                'bg-yellow-500'
            }`;
            notification.textContent = message;

            notificationContainer.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        // Custom Prompt Function (replaces browser's prompt)
        function customPrompt(message, defaultValue = '') {
            return new Promise(resolve => {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100]';

                const modalContent = document.createElement('div');
                modalContent.className = 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4';
                modalContent.innerHTML = `
                    <p class="text-lg font-semibold mb-4 text-gray-800">${message}</p>
                    <input type="text" id="customPromptInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4" value="${defaultValue}">
                    <div class="flex justify-end space-x-3">
                        <button id="customPromptCancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">ยกเลิก</button>
                        <button id="customPromptOk" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">ตกลง</button>
                    </div>
                `;

                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);

                const input = document.getElementById('customPromptInput');
                input.focus();

                document.getElementById('customPromptOk').addEventListener('click', () => {
                    resolve(input.value);
                    modalOverlay.remove();
                });

                document.getElementById('customPromptCancel').addEventListener('click', () => {
                    resolve(null);
                    modalOverlay.remove();
                });

                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('customPromptOk').click();
                    }
                });
            });
        }

        // Custom Confirm Function (replaces browser's confirm)
        function customConfirm(message) {
            return new Promise(resolve => {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100]';

                const modalContent = document.createElement('div');
                modalContent.className = 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4';
                modalContent.innerHTML = `
                    <p class="text-lg font-semibold mb-4 text-gray-800">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="customConfirmCancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">ยกเลิก</button>
                        <button id="customConfirmOk" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">ตกลง</button>
                    </div>
                `;

                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);

                document.getElementById('customConfirmOk').addEventListener('click', () => {
                    resolve(true);
                    modalOverlay.remove();
                });

                document.getElementById('customConfirmCancel').addEventListener('click', () => {
                    resolve(false);
                    modalOverlay.remove();
                });
            });
        }
    </script>

    <!-- PWA: Inline Service Worker Script -->
    <script id="service-worker-script" type="javascript/worker">
        const CACHE_NAME = 'wallet-wise-cache-v1';
        const urlsToCache = [
            '/',
            '/index.html',
            '/manifest.json',
            '/icons/icon-192x192.png',
            '/icons/icon-512x512.png',
            '/icons/apple-touch-icon.png',
            '/icons/favicon-32x32.png',
            '/icons/favicon-16x16.png',
            'https://cdn.tailwindcss.com',
            'https://cdn.jsdelivr.net/npm/chart.js',
            'https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap'
        ];

        // Install event: cache all necessary assets
        self.addEventListener('install', (event) => {
            console.log('[Service Worker] Installing...');
            event.waitUntil(
                caches.open(CACHE_NAME)
                    .then((cache) => {
                        console.log('[Service Worker] Caching app shell');
                        return cache.addAll(urlsToCache);
                    })
                    .catch(error => {
                        console.error('[Service Worker] Caching failed:', error);
                    })
            );
        });

        // Activate event: clean up old caches
        self.addEventListener('activate', (event) => {
            console.log('[Service Worker] Activating...');
            event.waitUntil(
                caches.keys().then((cacheNames) => {
                    return Promise.all(
                        cacheNames.map((cacheName) => {
                            if (cacheName !== CACHE_NAME) {
                                console.log('[Service Worker] Deleting old cache:', cacheName);
                                return caches.delete(cacheName);
                            }
                        })
                    );
                })
            );
        });

        // Fetch event: serve from cache if available, otherwise fetch from network
        self.addEventListener('fetch', (event) => {
            // Only handle HTTP/HTTPS requests, ignore chrome-extension:// etc.
            if (!event.request.url.startsWith('http')) {
                return;
            }

            // Exclude Google Apps Script URL from caching, always go to network
            if (event.request.url.includes('script.google.com/macros/s/')) {
                event.respondWith(fetch(event.request));
                return;
            }

            event.respondWith(
                caches.match(event.request)
                    .then((response) => {
                        // Cache hit - return response
                        if (response) {
                            console.log('[Service Worker] Serving from cache:', event.request.url);
                            return response;
                        }
                        // No cache hit - fetch from network
                        console.log('[Service Worker] Fetching from network:', event.request.url);
                        return fetch(event.request)
                            .then(networkResponse => {
                                // Put a copy of the response in the cache
                                return caches.open(CACHE_NAME).then(cache => {
                                    // Do not cache opaque responses (e.g., cross-origin no-cors)
                                    if (networkResponse.ok || networkResponse.type === 'opaque') {
                                        cache.put(event.request, networkResponse.clone());
                                    }
                                    return networkResponse;
                                });
                            })
                            .catch(() => {
                                // If both cache and network fail, check for specific offline fallbacks
                                if (event.request.mode === 'navigate') { // For navigation requests
                                    // You could serve an offline page here
                                    // return caches.match('/offline.html');
                                }
                                // Otherwise, simply throw the error
                                throw new Error('Network request failed and no cache found.');
                            });
                    })
            );
        });

    </script>
    <!-- PWA: Inline Manifest Data -->
    <script id="manifest-data" type="application/json">
        {
            "name": "Wallet Wise",
            "short_name": "Wallet Wise",
            "description": "จัดการเงินของคุณอย่างชาญฉลาด",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#764ba2",
            "theme_color": "#667eea",
            "icons": [
                {
                    "src": "/icons/icon-192x192.png",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "/icons/icon-512x512.png",
                    "sizes": "512x512",
                    "type": "image/png"
                },
                {
                    "src": "/icons/icon-maskable-192x192.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "maskable"
                },
                {
                    "src": "/icons/icon-maskable-512x512.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "maskable"
                }
            ]
        }
    </script>

    <script>
        // Inject manifest.json dynamically
        function injectManifest() {
            const manifestDataScript = document.getElementById('manifest-data');
            const manifestData = JSON.parse(manifestDataScript.textContent);
            const blob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(blob);
            document.querySelector('link[rel="manifest"]').setAttribute('href', manifestUrl);
        }

        // Inject service-worker.js dynamically
        function injectServiceWorker() {
            const serviceWorkerScript = document.getElementById('service-worker-script');
            const serviceWorkerContent = serviceWorkerScript.textContent;
            const blob = new Blob([serviceWorkerContent], { type: 'application/javascript' });
            const serviceWorkerUrl = URL.createObjectURL(blob);

            // Override the default service worker registration to use our blob URL
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for (let registration of registrations) {
                        registration.unregister(); // Unregister any existing service workers
                    }
                }).then(() => {
                    navigator.serviceWorker.register(serviceWorkerUrl)
                        .then(registration => {
                            console.log('Service Worker registered with scope:', registration.scope);
                            showNotification('แอปพร้อมใช้งานแบบออฟไลน์แล้ว', 'info');
                        })
                        .catch(error => {
                            console.error('Service Worker registration failed:', error);
                            showNotification('ไม่สามารถเปิดใช้งานออฟไลน์ได้', 'error');
                        });
                });
            }
        }

        // Call these injection functions after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            injectManifest();
            injectServiceWorker();
        });
    </script>
</body>
</html>
�
