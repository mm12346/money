<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Wise - จัดการเงินอย่างฉลาด</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#764ba2"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/764ba2/ffffff?text=WW">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .income-color { color: #10b981; }
        .expense-color { color: #ef4444; }
        .tab-active { color: #667eea; }
        .bottom-nav .tab-active { background: transparent; color: #667eea; }
        .bottom-nav .tab-btn { transition: all 0.2s ease; }
        .category-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        #syncPopup, #addTransactionModal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Sync Status Popup -->
    <div id="syncPopup" class="fixed top-4 left-4 z-[60] p-3 rounded-lg text-white card-shadow opacity-0 transform -translate-x-full">
        <span id="syncMessage"></span>
    </div>

    <!-- Header -->
    <div class="gradient-bg text-white p-6 rounded-b-3xl">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold">Wallet Wise</h1>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="loadFromGoogleSheets()" class="bg-white bg-opacity-20 rounded-full p-2 hover:bg-opacity-30 transition-colors" title="โหลดข้อมูลจาก Google Sheets">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                </button>
                <button onclick="debugGoogleSheets()" class="bg-white bg-opacity-20 rounded-full p-2 hover:bg-opacity-30 transition-colors" title="ตรวจสอบการเชื่อมต่อ (เปิด Console)">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
                </button>
                <div class="bg-white bg-opacity-20 rounded-full p-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2L13 9h7l-5.5 4 2 7L10 15l-6.5 5 2-7L0 9h7l3-7z"/></svg>
                </div>
            </div>
        </div>
        <div class="bg-white bg-opacity-20 rounded-2xl p-4 mb-4">
            <p class="text-sm opacity-90">ยอดเงินคงเหลือ</p>
            <p class="text-3xl font-bold" id="totalBalance">฿0</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-green-500 bg-opacity-90 rounded-xl p-3 text-center"><p class="text-sm opacity-90">รายรับ</p><p class="text-xl font-semibold" id="totalIncome">฿0</p></div>
            <div class="bg-red-500 bg-opacity-90 rounded-xl p-3 text-center"><p class="text-sm opacity-90">รายจ่าย</p><p class="text-xl font-semibold" id="totalExpense">฿0</p></div>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-content" class="tab-content p-4 pb-24">
        <div class="bg-white rounded-2xl p-4 mb-4 card-shadow"><h3 class="text-lg font-semibold mb-4">รายจ่ายตามหมวดหมู่</h3><div class="h-48"><canvas id="expenseChart"></canvas></div></div>
        <div class="bg-white rounded-2xl p-4 card-shadow"><h3 class="text-lg font-semibold mb-4">รายการล่าสุด</h3><div id="recentTransactions"><p class="text-gray-500 text-center py-8">ยังไม่มีรายการ</p></div></div>
    </div>

    <!-- Budget Tab -->
    <div id="budget-content" class="tab-content p-4 pb-24 hidden">
        <div class="bg-white rounded-2xl p-6 card-shadow mb-4">
            <h3 class="text-xl font-semibold mb-6">ตั้งงบประมาณ</h3>
            <form id="budgetForm">
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label><select id="budgetCategory" class="w-full p-3 border border-gray-300 rounded-xl" required></select></div>
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">งบประมาณ (บาท)</label><input type="number" id="budgetAmount" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="5000" required></div>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 px-4 rounded-xl font-medium">ตั้งงบประมาณ</button>
            </form>
        </div>
        <div class="bg-white rounded-2xl p-6 card-shadow"><h3 class="text-lg font-semibold mb-4">งบประมาณปัจจุบัน</h3><div id="budgetList"><p class="text-gray-500 text-center py-8">ยังไม่มีงบประมาณ</p></div></div>
    </div>

    <!-- History Tab -->
    <div id="history-content" class="tab-content p-4 pb-24 hidden">
        <div class="bg-white rounded-2xl p-4 mb-4 card-shadow">
            <h3 class="text-lg font-semibold mb-4">กรองข้อมูล</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">ประเภท</label><select id="filterType" class="w-full p-3 border border-gray-300 rounded-xl"><option value="all">ทั้งหมด</option><option value="income">รายรับ</option><option value="expense">รายจ่าย</option></select></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label><select id="filterCategory" class="w-full p-3 border border-gray-300 rounded-xl"><option value="all">ทั้งหมด</option></select></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">จากวันที่</label><input type="date" id="filterFromDate" class="w-full p-3 border border-gray-300 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">ถึงวันที่</label><input type="date" id="filterToDate" class="w-full p-3 border border-gray-300 rounded-xl"></div>
            </div>
            <button onclick="applyFilters()" class="w-full mt-4 bg-blue-600 text-white py-3 px-4 rounded-xl font-medium">กรองข้อมูล</button>
        </div>
        <div class="bg-white rounded-2xl p-4 mb-4 card-shadow">
            <h3 class="text-lg font-semibold mb-4">สรุปรายการ</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div><p class="text-2xl font-bold text-blue-600" id="filteredCount">0</p><p class="text-sm text-gray-600">รายการ</p></div>
                <div><p class="text-2xl font-bold text-green-600" id="filteredIncome">฿0</p><p class="text-sm text-gray-600">รายรับ</p></div>
                <div><p class="text-2xl font-bold text-red-600" id="filteredExpense">฿0</p><p class="text-sm text-gray-600">รายจ่าย</p></div>
            </div>
        </div>
        <div class="bg-white rounded-2xl p-4 card-shadow">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">รายการทั้งหมด</h3><button onclick="exportToCSV()" class="text-blue-600 text-sm hover:underline">ส่งออก CSV</button></div>
            <div id="historyList"><p class="text-gray-500 text-center py-8">ยังไม่มีรายการ</p></div>
        </div>
    </div>

    <!-- Goals/Targets Tab -->
    <div id="goals-content" class="tab-content p-4 pb-24 hidden">
        <div class="bg-white rounded-2xl p-6 card-shadow mb-4">
            <h3 class="text-xl font-semibold mb-6">ตั้งเป้าหมายรายจ่าย</h3>
            <form id="targetForm">
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label><select id="targetCategory" class="w-full p-3 border border-gray-300 rounded-xl" required></select></div>
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">เป้าหมาย (บาท/เดือน)</label><input type="number" id="targetAmount" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="5000" required></div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-xl font-medium">ตั้งเป้าหมาย</button>
            </form>
        </div>
        <div class="bg-white rounded-2xl p-6 card-shadow"><h3 class="text-lg font-semibold mb-4">เป้าหมายรายจ่ายประจำเดือน</h3><div id="targetsList"><p class="text-gray-500 text-center py-8">ยังไม่มีเป้าหมาย</p></div></div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden opacity-0" onclick="hideTransactionModal(event)">
        <div class="bg-white rounded-2xl p-6 mx-4 max-w-sm w-full card-shadow relative modal-content transform scale-95" onclick="event.stopPropagation()">
            <button onclick="hideTransactionModal({target: document.getElementById('addTransactionModal')})" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 p-1 rounded-full">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
            </button>
            <h3 id="modalTitle" class="text-xl font-semibold mb-6">เพิ่มรายการใหม่</h3>
            <div class="flex mb-6">
                <button id="modalIncomeBtn" class="flex-1 py-3 px-4 rounded-l-xl">รายรับ</button>
                <button id="modalExpenseBtn" class="flex-1 py-3 px-4 rounded-r-xl">รายจ่าย</button>
            </div>
            <form id="transactionForm">
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">จำนวนเงิน</label><input type="number" id="amount" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="0" required></div>
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label><select id="category" class="w-full p-3 border border-gray-300 rounded-xl" required></select></div>
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">รายละเอียด</label><input type="text" id="description" class="w-full p-3 border border-gray-300 rounded-xl" placeholder="เช่น ค่าอาหารเที่ยง"></div>
                <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">วันที่</label><input type="date" id="date" class="w-full p-3 border border-gray-300 rounded-xl" required></div>
                <button id="modalSubmitBtn" type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-xl font-medium">บันทึกรายการ</button>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-2xl p-6 mx-4 max-w-sm w-full card-shadow">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"/></svg></div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">ยืนยันการลบ</h3>
                <p class="text-gray-600 mb-6">คุณต้องการลบรายการนี้หรือไม่?<br>การดำเนินการนี้ไม่สามารถยกเลิกได้</p>
                <div class="flex space-x-3">
                    <button onclick="cancelDelete()" class="flex-1 bg-gray-200 text-gray-800 py-3 px-4 rounded-xl font-medium">ยกเลิก</button>
                    <button onclick="confirmDelete()" class="flex-1 bg-red-500 text-white py-3 px-4 rounded-xl font-medium">ลบ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <button onclick="showTransactionModal()" class="fixed bottom-20 right-6 bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center card-shadow hover:bg-blue-700 transition-transform transform hover:scale-110 z-40">
        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
    </button>

    <!-- Bottom Navigation -->
    <div class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2 z-50">
        <div class="flex justify-around items-center">
            <button class="tab-btn flex flex-col items-center py-2 px-3 rounded-lg tab-active" data-tab="dashboard"><svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/></svg><span class="text-xs font-medium">ภาพรวม</span></button>
            <button class="tab-btn flex flex-col items-center py-2 px-3 rounded-lg text-gray-600" data-tab="budget"><svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/></svg><span class="text-xs font-medium">งบประมาณ</span></button>
            <button class="tab-btn flex flex-col items-center py-2 px-3 rounded-lg text-gray-600" data-tab="history"><svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/></svg><span class="text-xs font-medium">ประวัติ</span></button>
            <button class="tab-btn flex flex-col items-center py-2 px-3 rounded-lg text-gray-600" data-tab="goals"><svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span class="text-xs font-medium">เป้าหมาย</span></button>
        </div>
    </div>

    <script>
        // Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz-GeWsgVd8EoCNX7CCm-q2cyc-5AArBoNikndow4OlexS-g2tGZAZR236LiiAuswhm/exec';
        const DEBUG_MODE = true;
        
        // App State
        let transactions = [];
        let budgets = [];
        let targets = [];
        let currentType = 'expense';
        let editingTransaction = null;

        // Categories
        const categories = {
            income: ['เงินเดือน', 'โบนัส', 'ขายของ', 'ลงทุน', 'อื่นๆ'],
            expense: ['อาหาร', 'การเดินทาง', 'ช้อปปิ้ง', 'บิล', 'บันเทิง', 'สุขภาพ', 'การศึกษา', 'อื่นๆ']
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializePWA();
            initializeTabs();
            initializeTransactionModal();
            initializeBudgetForm();
            initializeTargetForm();
            initializeHistoryPage();
            loadFromGoogleSheets();
        });

        function initializeTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                    btn.classList.add('tab-active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(btn.dataset.tab + '-content').classList.remove('hidden');
                });
            });
        }
        
        // --- PWA Initialization ---
        function initializePWA() {
            // 1. Create and link manifest
            const manifest = {
                "name": "Wallet Wise - จัดการเงินอย่างฉลาด",
                "short_name": "Wallet Wise",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#f9fafb",
                "theme_color": "#764ba2",
                "description": "แอปพลิเคชันจัดการรายรับ-รายจ่ายส่วนตัว",
                "icons": [
                    { "src": "https://placehold.co/192x192/764ba2/ffffff?text=WW", "sizes": "192x192", "type": "image/png" },
                    { "src": "https://placehold.co/512x512/764ba2/ffffff?text=WW", "sizes": "512x512", "type": "image/png" }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(manifestBlob);
            const linkManifest = document.createElement('link');
            linkManifest.rel = 'manifest';
            linkManifest.href = manifestURL;
            document.head.appendChild(linkManifest);

            // 2. Register Service Worker
            if ('serviceWorker' in navigator) {
                const swContent = `
                    const CACHE_NAME = 'wallet-wise-cache-v1';
                    const urlsToCache = [
                        '/',
                        'https://cdn.tailwindcss.com',
                        'https://cdn.jsdelivr.net/npm/chart.js',
                        'https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap'
                    ];
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                const swBlob = new Blob([swContent], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swURL)
                    .then(reg => console.log('Service Worker registered successfully', reg))
                    .catch(err => console.error('Service Worker registration failed', err));
            }
        }


        // --- Google Sheets Sync ---
        async function syncToGoogleSheets(data, action, type, id = null) {
            if (DEBUG_MODE) console.log('Sync attempt:', { action, type, data, id });
            try {
                showSyncStatus('กำลังซิงค์...', 'syncing');
                const payload = { action, type, data, id };
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'cors' });
                const result = await response.json();
                if (result && result.success) {
                    showSyncStatus('ซิงค์สำเร็จ', 'success');
                } else { throw new Error(result?.error || 'Sync failed'); }
            } catch (error) {
                if (DEBUG_MODE) console.error('Sync error:', error);
                showSyncStatus('ใช้ข้อมูลในเครื่อง', 'error');
            }
        }

        async function loadFromGoogleSheets() {
            try {
                showSyncStatus('กำลังโหลดข้อมูล...', 'syncing');
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=load`, { method: 'GET', mode: 'cors' });
                const result = await response.json();
                if (result && result.success) {
                    transactions = Array.isArray(result.transactions) ? result.transactions.filter(t => t && t.id) : [];
                    budgets = Array.isArray(result.budgets) ? result.budgets : [];
                    targets = Array.isArray(result.targets) ? result.targets : [];
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    localStorage.setItem('budgets', JSON.stringify(budgets));
                    localStorage.setItem('targets', JSON.stringify(targets));
                    showSyncStatus('โหลดข้อมูลสำเร็จ', 'success');
                } else { throw new Error(result?.error || 'Load failed'); }
            } catch (error) {
                if (DEBUG_MODE) console.error('Load error:', error);
                transactions = JSON.parse(localStorage.getItem('transactions')) || [];
                budgets = JSON.parse(localStorage.getItem('budgets')) || [];
                targets = JSON.parse(localStorage.getItem('targets')) || [];
                showSyncStatus('ใช้ข้อมูลในเครื่อง', 'error');
            } finally {
                // FIX: Sort transactions after loading to ensure newest is always first.
                transactions.sort((a, b) => b.id - a.id);
                updateAllDisplays();
            }
        }

        // --- UI Updates ---
        function updateAllDisplays() {
            updateSummary();
            updateChart();
            updateRecentTransactions();
            updateBudgetDisplay();
            updateTargetsDisplay();
            applyFilters();
        }

        function showSyncStatus(message, status) {
            const syncPopup = document.getElementById('syncPopup');
            const syncMessage = document.getElementById('syncMessage');
            if (!syncPopup || !syncMessage) return;
            syncMessage.textContent = message;
            syncPopup.className = `fixed top-4 left-4 z-[60] p-3 rounded-lg text-white card-shadow transform transition-all duration-300`;
            const colorClass = { syncing: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' }[status] || 'bg-gray-500';
            syncPopup.classList.add(colorClass, 'opacity-100', 'translate-x-0');
            if (status !== 'syncing') {
                setTimeout(() => syncPopup.classList.remove('opacity-100', 'translate-x-0'), 2500);
            }
        }

        // --- Transaction Modal & Form ---
        function initializeTransactionModal() {
            const form = document.getElementById('transactionForm');
            form.addEventListener('submit', (e) => { e.preventDefault(); addTransaction(); });
            document.getElementById('modalIncomeBtn').addEventListener('click', () => setTransactionType('income'));
            document.getElementById('modalExpenseBtn').addEventListener('click', () => setTransactionType('expense'));
        }

        function showTransactionModal(isEditing = false) {
            const modal = document.getElementById('addTransactionModal');
            const modalContent = modal.querySelector('.modal-content');
            const form = document.getElementById('transactionForm');
            
            if (!isEditing) {
                editingTransaction = null;
                form.reset();
                document.getElementById('modalTitle').textContent = 'เพิ่มรายการใหม่';
                document.getElementById('modalSubmitBtn').textContent = 'บันทึกรายการ';
                setTransactionType('expense');
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function hideTransactionModal(event) {
            if (event && event.target.id !== 'addTransactionModal') return;
            const modal = document.getElementById('addTransactionModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function setTransactionType(type) {
            currentType = type;
            const incomeBtn = document.getElementById('modalIncomeBtn');
            const expenseBtn = document.getElementById('modalExpenseBtn');
            const activeClass = type === 'income' ? 'bg-green-500 text-white' : 'bg-red-500 text-white';
            const inactiveClass = 'bg-gray-200 text-gray-700';
            
            incomeBtn.className = `flex-1 py-3 px-4 rounded-l-xl font-medium ${type === 'income' ? activeClass : inactiveClass}`;
            expenseBtn.className = `flex-1 py-3 px-4 rounded-r-xl font-medium ${type === 'expense' ? activeClass : inactiveClass}`;
            
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '<option value="">เลือกหมวดหมู่</option>';
            categories[currentType].forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        async function addTransaction() {
            const transaction = {
                id: editingTransaction ? editingTransaction.id : Date.now(),
                type: currentType,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                date: document.getElementById('date').value
            };

            if (!transaction.amount || !transaction.category || !transaction.date) return;

            if (editingTransaction) {
                const index = transactions.findIndex(t => t.id === editingTransaction.id);
                if (index !== -1) transactions[index] = transaction;
                syncToGoogleSheets(transaction, 'update', 'transaction', transaction.id);
            } else {
                transactions.unshift(transaction);
                syncToGoogleSheets(transaction, 'add', 'transaction');
            }
            
            localStorage.setItem('transactions', JSON.stringify(transactions));
            hideTransactionModal({target: document.getElementById('addTransactionModal')});
            updateAllDisplays();
        }
        
        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            
            editingTransaction = transaction;
            setTransactionType(transaction.type);
            
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('category').value = transaction.category;
            document.getElementById('description').value = transaction.description;
            document.getElementById('date').value = transaction.date;
            document.getElementById('modalTitle').textContent = 'แก้ไขรายการ';
            document.getElementById('modalSubmitBtn').textContent = 'อัปเดตรายการ';
            
            showTransactionModal(true);
        }

        // --- Budget ---
        function initializeBudgetForm() {
            const form = document.getElementById('budgetForm');
            const categorySelect = document.getElementById('budgetCategory');
            categorySelect.innerHTML = '<option value="">เลือกหมวดหมู่</option>';
            categories.expense.forEach(cat => categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`);
            form.addEventListener('submit', (e) => { e.preventDefault(); addBudget(); });
        }

        async function addBudget() {
            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);
            if (!category || !amount) return;
            
            const existingIndex = budgets.findIndex(b => b.category === category);
            if (existingIndex >= 0) {
                budgets[existingIndex].amount = amount;
                syncToGoogleSheets(budgets[existingIndex], 'update', 'budget', budgets[existingIndex].id);
            } else {
                const budget = { id: Date.now(), category, amount };
                budgets.push(budget);
                syncToGoogleSheets(budget, 'add', 'budget');
            }
            localStorage.setItem('budgets', JSON.stringify(budgets));
            document.getElementById('budgetForm').reset();
            updateBudgetDisplay();
        }

        function updateBudgetDisplay() {
            const budgetList = document.getElementById('budgetList');
            if (budgets.length === 0) {
                budgetList.innerHTML = '<p class="text-gray-500 text-center py-8">ยังไม่มีงบประมาณ</p>';
                return;
            }
            budgetList.innerHTML = budgets.map(budget => {
                const spent = getSpentAmount(budget.category);
                const percentage = budget.amount > 0 ? (spent / budget.amount) * 100 : 0;
                const isOver = percentage > 100;
                const color = isOver ? 'bg-red-500' : percentage > 80 ? 'bg-yellow-500' : 'bg-green-500';
                return `
                    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">${budget.category}</span>
                            <span class="text-sm ${isOver ? 'text-red-600' : 'text-gray-600'}">฿${spent.toLocaleString()} / ฿${budget.amount.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2"><div class="${color} h-2 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div></div>
                    </div>`;
            }).join('');
        }

        // --- Targets ---
        function initializeTargetForm() {
            const form = document.getElementById('targetForm');
            const categorySelect = document.getElementById('targetCategory');
            categorySelect.innerHTML = '<option value="">เลือกหมวดหมู่</option>';
            categories.expense.forEach(cat => categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`);
            form.addEventListener('submit', (e) => { e.preventDefault(); addTarget(); });
        }

        async function addTarget() {
            const category = document.getElementById('targetCategory').value;
            const amount = parseFloat(document.getElementById('targetAmount').value);
            if(!category || !amount) return;

            const existingIndex = targets.findIndex(t => t.category === category);
            if (existingIndex >= 0) {
                targets[existingIndex].amount = amount;
                syncToGoogleSheets(targets[existingIndex], 'update', 'target', targets[existingIndex].id);
            } else {
                const target = { id: Date.now(), category, amount };
                targets.push(target);
                syncToGoogleSheets(target, 'add', 'target');
            }
            localStorage.setItem('targets', JSON.stringify(targets));
            document.getElementById('targetForm').reset();
            updateTargetsDisplay();
        }

        function updateTargetsDisplay() {
            const targetsList = document.getElementById('targetsList');
            if (targets.length === 0) {
                targetsList.innerHTML = '<p class="text-gray-500 text-center py-8">ยังไม่มีเป้าหมาย</p>';
                return;
            }
            targetsList.innerHTML = targets.map(target => {
                const spent = getSpentAmount(target.category);
                const percentage = target.amount > 0 ? (spent / target.amount) * 100 : 0;
                const isOver = percentage > 100;
                const color = isOver ? 'bg-red-500' : percentage > 80 ? 'bg-yellow-500' : 'bg-green-500';
                return `
                    <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">${target.category}</span>
                            <span class="text-sm ${isOver ? 'text-red-600' : 'text-gray-600'}">ใช้ไป ${percentage.toFixed(0)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${color} h-2.5 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div></div>
                        <p class="text-xs mt-1 text-gray-500">ใช้ไป ฿${spent.toLocaleString()} จากเป้าหมาย ฿${target.amount.toLocaleString()}</p>
                    </div>`;
            }).join('');
        }
        
        // --- Dashboard & History ---
        function updateSummary() {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            document.getElementById('totalBalance').textContent = `฿${(totalIncome - totalExpense).toLocaleString()}`;
            document.getElementById('totalIncome').textContent = `฿${totalIncome.toLocaleString()}`;
            document.getElementById('totalExpense').textContent = `฿${totalExpense.toLocaleString()}`;
        }

        function updateChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const expenseData = transactions.filter(t => t.type === 'expense').reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});
            if (window.expenseChart && typeof window.expenseChart.destroy === 'function') {
                window.expenseChart.destroy();
            }
            if (Object.keys(expenseData).length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Kanit'; ctx.fillStyle = '#6b7280'; ctx.textAlign = 'center';
                ctx.fillText('ยังไม่มีข้อมูลรายจ่าย', ctx.canvas.width / 2, ctx.canvas.height / 2);
                window.expenseChart = null;
                return;
            }
            window.expenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(expenseData),
                    datasets: [{ data: Object.values(expenseData), backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#6b7280'], borderRadius: 8 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateRecentTransactions() {
            const recentList = document.getElementById('recentTransactions');
            if (transactions.length === 0) {
                recentList.innerHTML = '<p class="text-gray-500 text-center py-8">ยังไม่มีรายการ</p>';
                return;
            }
            recentList.innerHTML = transactions.slice(0, 5).map(t => `
                <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
                    <div class="flex items-center"><div class="category-icon ${t.type === 'income' ? 'bg-green-100' : 'bg-red-100'} mr-3"><span class="text-lg">${getCategoryIcon(t.category, t.type)}</span></div><div><p class="font-medium">${t.description || t.category}</p><p class="text-sm text-gray-500">${formatDate(t.date)}</p></div></div>
                    <span class="font-semibold ${t.type === 'income' ? 'income-color' : 'expense-color'}">${t.type === 'income' ? '+' : '-'}฿${t.amount.toLocaleString()}</span>
                </div>`).join('');
        }

        let filteredTransactions = [];
        function initializeHistoryPage() {
            updateFilterCategories();
            const today = new Date();
            const thirtyDaysAgo = new Date(new Date().setDate(today.getDate() - 30));
            document.getElementById('filterFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('filterToDate').value = today.toISOString().split('T')[0];
        }

        function updateFilterCategories() {
            const filterCategory = document.getElementById('filterCategory');
            const allCats = [...new Set([...categories.income, ...categories.expense])];
            filterCategory.innerHTML = '<option value="all">ทั้งหมด</option>';
            allCats.forEach(cat => filterCategory.innerHTML += `<option value="${cat}">${cat}</option>`);
        }

        function applyFilters() {
            const type = document.getElementById('filterType').value;
            const category = document.getElementById('filterCategory').value;
            const from = document.getElementById('filterFromDate').value;
            const to = document.getElementById('filterToDate').value;
            filteredTransactions = transactions.filter(t => (type === 'all' || t.type === type) && (category === 'all' || t.category === category) && (!from || t.date >= from) && (!to || t.date <= to));
            updateHistoryDisplay();
            updateFilteredSummary();
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            if (filteredTransactions.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-8">ไม่พบรายการ</p>';
                return;
            }
            const grouped = filteredTransactions.reduce((groups, t) => {
                if (!groups[t.date]) groups[t.date] = [];
                groups[t.date].push(t);
                return groups;
            }, {});
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            historyList.innerHTML = sortedDates.map(date => {
                const dayTotal = grouped[date].reduce((s, t) => s + (t.type === 'income' ? t.amount : -t.amount), 0);
                return `
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b"><h4 class="font-semibold text-gray-800">${formatDate(date)}</h4><span class="font-semibold ${dayTotal >= 0 ? 'text-green-600' : 'text-red-600'}">${dayTotal >= 0 ? '+' : ''}฿${Math.abs(dayTotal).toLocaleString()}</span></div>
                        <div class="space-y-3">
                        ${grouped[date].map(t => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center"><div class="category-icon ${t.type === 'income' ? 'bg-green-100' : 'bg-red-100'} mr-3"><span class="text-lg">${getCategoryIcon(t.category, t.type)}</span></div><div><p class="font-medium">${t.description || t.category}</p><p class="text-sm text-gray-500">${t.category}</p></div></div>
                                <div class="flex flex-col items-end">
                                    <span class="font-semibold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'}฿${t.amount.toLocaleString()}</span>
                                    <div class="flex space-x-2 mt-1">
                                        <button onclick="editTransaction(${t.id})" class="text-xs text-blue-500 hover:underline">แก้ไข</button>
                                        <button onclick="deleteTransaction(${t.id})" class="text-xs text-red-500 hover:underline">ลบ</button>
                                    </div>
                                </div>
                            </div>`).join('')}
                        </div>
                    </div>`;
            }).join('');
        }

        function updateFilteredSummary() {
            const income = filteredTransactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = filteredTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            document.getElementById('filteredCount').textContent = filteredTransactions.length;
            document.getElementById('filteredIncome').textContent = `฿${income.toLocaleString()}`;
            document.getElementById('filteredExpense').textContent = `฿${expense.toLocaleString()}`;
        }
        
        // --- Deletion ---
        let itemToDelete = null;
        function deleteTransaction(id) {
            itemToDelete = { id, type: 'transaction' };
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function cancelDelete() {
            itemToDelete = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }

        async function confirmDelete() {
            if (itemToDelete && itemToDelete.type === 'transaction') {
                transactions = transactions.filter(t => t.id !== itemToDelete.id);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                syncToGoogleSheets(null, 'delete', 'transaction', itemToDelete.id);
                updateAllDisplays();
            }
            cancelDelete();
        }

        // --- Utility Functions ---
        function getCategoryIcon(category, type) {
            if (type === 'income') return '💰';
            const icons = {'อาหาร': '🍽️', 'การเดินทาง': '🚗', 'ช้อปปิ้ง': '🛍️', 'บิล': '📄', 'บันเทิง': '🎬', 'สุขภาพ': '🏥', 'การศึกษา': '📚'};
            return icons[category] || '💳';
        }
        function getSpentAmount(category) {
            const today = new Date();
            return transactions.filter(t => {
                const tDate = new Date(t.date);
                return t.type === 'expense' && t.category === category && tDate.getMonth() === today.getMonth() && tDate.getFullYear() === today.getFullYear();
            }).reduce((sum, t) => sum + t.amount, 0);
        }
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        function exportToCSV() {
            if (filteredTransactions.length === 0) return;
            const headers = ['วันที่', 'ประเภท', 'หมวดหมู่', 'รายละเอียด', 'จำนวนเงิน'];
            const csv = [headers.join(','), ...filteredTransactions.map(t => [t.date, t.type, t.category, `"${t.description || ''}"`, t.amount].join(','))].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `wallet-wise-export.csv`;
            link.click();
        }
        function debugGoogleSheets() {
            console.log('=== Google Sheets Debug Info ===');
            console.log('Script URL:', GOOGLE_SCRIPT_URL);
            fetch(`${GOOGLE_SCRIPT_URL}?action=ping`).then(res => res.text()).then(text => console.log('Ping response:', text)).catch(err => console.error('Ping failed:', err));
        }
    </script>
</body>
</html>
